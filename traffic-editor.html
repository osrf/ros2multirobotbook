<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Traffic Editor - Programming Multiple Robots with ROS 2</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="open-in.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="installation.html"><strong aria-hidden="true">1.1.</strong> Installation</a></li><li class="chapter-item "><a href="demos.html"><strong aria-hidden="true">1.2.</strong> Demos</a></li></ol></li><li class="chapter-item "><a href="ros2.html"><strong aria-hidden="true">2.</strong> ROS 2</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ros2_tools_resources.html"><strong aria-hidden="true">2.1.</strong> ROS Resources</a></li><li class="chapter-item "><a href="ros2_design_patterns.html"><strong aria-hidden="true">2.2.</strong> ROS Concepts and Design Patterns</a></li><li class="chapter-item "><a href="ros2_cli.html"><strong aria-hidden="true">2.3.</strong> The ROS Command Line Interface</a></li><li class="chapter-item "><a href="ros2_api.html"><strong aria-hidden="true">2.4.</strong> The ROS API</a></li></ol></li><li class="chapter-item expanded "><a href="traffic-editor.html" class="active"><strong aria-hidden="true">3.</strong> Traffic Editor</a></li><li class="chapter-item "><a href="simulation.html"><strong aria-hidden="true">4.</strong> Simulation</a></li><li class="chapter-item "><a href="rmf-core.html"><strong aria-hidden="true">5.</strong> RMF Core Overview</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="rmf-core_faq.html"><strong aria-hidden="true">5.1.</strong> Frequently Asked Questions</a></li></ol></li><li class="chapter-item "><a href="task.html"><strong aria-hidden="true">6.</strong> Tasks in RMF</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="task_planner.html"><strong aria-hidden="true">6.1.</strong> RMF Task Allocation Planner</a></li><li class="chapter-item "><a href="task_types.html"><strong aria-hidden="true">6.2.</strong> Currently supported Tasks</a></li><li class="chapter-item "><a href="task_userdefined.html"><strong aria-hidden="true">6.3.</strong> User-defined Tasks</a></li><li class="chapter-item "><a href="task_new.html"><strong aria-hidden="true">6.4.</strong> Supporting a new Task</a></li></ol></li><li class="chapter-item "><a href="soss.html"><strong aria-hidden="true">7.</strong> SOSS</a></li><li class="chapter-item "><a href="integration.html"><strong aria-hidden="true">8.</strong> Integration</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="integration_nav-maps.html"><strong aria-hidden="true">8.1.</strong> Navigation Maps</a></li><li class="chapter-item "><a href="integration_fleets.html"><strong aria-hidden="true">8.2.</strong> Mobile Robot Fleets</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="integration_fleets_tutorial.html"><strong aria-hidden="true">8.2.1.</strong> Tutorials</a></li></ol></li><li class="chapter-item "><a href="integration_free-fleet.html"><strong aria-hidden="true">8.3.</strong> Free Fleet</a></li><li class="chapter-item "><a href="integration_read-only.html"><strong aria-hidden="true">8.4.</strong> Read-Only Fleets</a></li><li class="chapter-item "><a href="integration_doors.html"><strong aria-hidden="true">8.5.</strong> Doors</a></li><li class="chapter-item "><a href="integration_lifts.html"><strong aria-hidden="true">8.6.</strong> Lifts (Elevators)</a></li><li class="chapter-item "><a href="integration_workcells.html"><strong aria-hidden="true">8.7.</strong> Workcells</a></li></ol></li><li class="chapter-item "><a href="rmf-web.html"><strong aria-hidden="true">9.</strong> RMF Web</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="ui.html"><strong aria-hidden="true">9.1.</strong> User Interfaces</a></li></ol></li><li class="chapter-item "><a href="security.html"><strong aria-hidden="true">10.</strong> Security</a></li><li class="chapter-item "><a href="roadmap.html"><strong aria-hidden="true">11.</strong> Roadmap</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Programming Multiple Robots with ROS 2</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/osrf/ros2multirobotbook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="traffic-editor"><a class="header" href="#traffic-editor">Traffic Editor</a></h1>
<p>This section describes the traffic-editor GUI and simulation tools.</p>
<h2 id="introduction-and-objectives"><a class="header" href="#introduction-and-objectives">Introduction and Objectives</a></h2>
<p>Traffic management of heterogeneous robot fleets is non-trivial. One of the
challenges with coordinated management arises from varying semantics in
information models used across fleets. Representations of waypoints, lanes,
charging/docking stations, restricted zones, infrastructure  systems such as
doors &amp; lifts, among others, are subject to vendor's discretion. However,
standardized conventions that convey the capabilities and intentions of fleets
in a shared facility are quintessential for planning. Multi-agent participants
in other modes of transportation such as roadways collectively adhere to a set
of rules and conventions which minimize chaos. More importantly, they allow for
a new participant to readily integrate into the system by following the
prescribed rules. Existing agents can accommodate the new participant as its
behavior is apparent.</p>
<p>Traffic conventions for multi-robot systems do not exist.
The objective of the <code>traffic_editor</code> is to fill this gap by expressing the
intentions of various fleets in a standardized, vendor neutral manner through a
graphical interface. Collated traffic information from different fleets can then
be exported for planning and control. A secondary objective and benefit of the
<code>traffic_editor</code> is to facilitate generation of 3D simulation worlds which
accurately reflect physical environments.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The <code>traffic_editor</code> <a href="https://github.com/open-rmf/rmf_traffic_editor">repository</a> is home to the <code>traffic_editor</code> GUI and tools to auto-generate simulation worlds from GUI output.
The GUI is an easy-to-use interface which can create and annotate 2D floor plans with robot traffic along with building infrastructure information.
Often times, there are existing floor plans of the environment, such as architectural drawings, which simplify the task and provide a &quot;reference&quot; coordinate system for vendor-specific maps.
For such cases, <code>traffic-editor</code> can import these types of &quot;backgroud images&quot; to serve as a canvas upon which to draw the intended robot traffic maps, and to make it easy to trace the important wall segments required for simulation.</p>
<p>The <code>traffic_editor</code> GUI projects are stored as <code>yaml</code> files with <code>.building.yaml</code> file extensions.
Although the typical workflow uses the GUI and does not require hand-editing the <code>yaml</code> files directly, we have used a <code>yaml</code> file format to make it easy to parse using custom scripting if needed.
Each <code>.building.yaml</code> file includes several attributes for each level in the site as annotated by the user.
An empty <code>.building.yaml</code> file appears below.
The GUI tries to make it easy to add and update content to these file.</p>
<pre><code class="language-yaml">levels:
  L1:
    doors:
      - []
    drawing:
      filename:
    fiducials:
    elevation: 0
    flattened_x_offset: 0
    flattened_y_offset: 0
    floors:
      - parameters: {}
        vertices: []
    lanes:
      - []
    layers:
      {}
    measurements:
      - []
    models:
      -{}
    vertices:
      {}
    walls:
      {}
lifts:
  {}
name: building

</code></pre>
<h2 id="gui-layout"><a class="header" href="#gui-layout">GUI Layout</a></h2>
<p>The layout of the <code>traffic_editor</code> includes a <code>Toolbar</code>, a <code>Working Area</code> and a <code>Sidebar</code> as seen in the figure below:</p>
<p><img src="images/traffic_editor/layout.png" alt="Traffic Editor GUI" /></p>
<p>The toolbar contains a variety of tools to support actions such as setting the scale of the drawing, aligning levels for multi-level scenarios, adding virtual models to simulated environments, adding robot traffic lanes, simulated flooring, and so on.</p>
<p>As usual in a modern GUI, the top Toolbar contains a variety of tools to interact with items in the main Working Area.
This document will introduce and explain the tools as an example project is created.
However, the first three tools in the toolbar are commonly found in 2D drawing tools, and should behave as expected:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Icon</th><th style="text-align: center">Name</th><th style="text-align: center">Shortkey</th><th style="text-align: center">Function</th></tr></thead><tbody>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/select.svg" alt="Select icon" /></td><td style="text-align: center">Select</td><td style="text-align: center"><code>Esc</code></td><td style="text-align: center">Select an entity in the <code>Working Area</code></td></tr>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/move.svg" alt="Move icon" /></td><td style="text-align: center">Move</td><td style="text-align: center"><code>m</code></td><td style="text-align: center">Move an entity in the <code>Working Area</code></td></tr>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/rotate.svg" alt="Rotate icon" /></td><td style="text-align: center">Rotate</td><td style="text-align: center"><code>r</code></td><td style="text-align: center">Rotate an entity in the <code>Working Area</code></td></tr>
</tbody></table>
</div>
<p>The <code>Working Area</code> is where the levels, along with their annotations, are rendered.
The user is able to zoom via the mouse scroll wheel, and pan the view by pressing the scroll wheel and moving the mouse cursor.</p>
<p>The <code>Sidebar</code> on the right side of the window contains multiple tabs with various functionalities:</p>
<ul>
<li><strong>levels:</strong> to add a new level to the building. This can be done from scratch or by importing a floor plan image file.</li>
<li><strong>layers:</strong> to overlap other images such as lidar maps over the level</li>
<li><strong>lifts:</strong> to configure and add lifts to the building</li>
<li><strong>traffic:</strong> to select which &quot;navigation graph&quot; is currently being edited, and toggle which graph(s) are being rendered.</li>
</ul>
<h2 id="annotation-guide"><a class="header" href="#annotation-guide">Annotation Guide</a></h2>
<p>This section walks through the process of annotating facilities while highlighting the capabilities of the <code>traffic_editor</code> GUI.</p>
<p>To create a new traffic editor <code>Building</code> file, launch the traffic editor from a terminal window (first sourcing the workspace if <code>traffic-editor</code> is built from source).
Then, click <code>Building -&gt; New...</code> and choose a location and filename for your <code>.building.yaml</code> file.</p>
<h3 id="adding-a-level"><a class="header" href="#adding-a-level">Adding a level</a></h3>
<p>A new level in the building can be added by clicking the <code>Add</code> button in the <code>levels</code> tab of the <code>Sidebar</code>.
The operation will open a dialog box where the <code>name</code>, <code>elevation</code> (in meters) and path to a 2D <code>drawing</code> file (<code>.png</code>) can be specified.
In most use cases, the floor plan for the level is used as the drawing.
If unspecified, the user may explicitly enter dimensions of the level in the fields provided.</p>
<p><img src="images/traffic_editor/add_level.png" alt="Add a level dialog" /></p>
<p>In the figure above, a new level <code>L1</code> at <code>0m</code> elevation and a floor plan have been added as reflected in the <code>levels</code> tab.
A default scale <code>1px = 5cm</code> is applied.
The actual scale can be set by adding a measurement.
Any offsets applied to align levels will be reflected in the <code>X</code> and <code>Y</code> columns.
Saving the project will update the <code>tutorial.building.yaml</code> files as seen below:</p>
<pre><code class="language-yaml">levels:
  L1:
    drawing:
      filename: office.png
    elevation: 0
    flattened_x_offset: 0
    flattened_y_offset: 0
    layers:
      {}
lifts:
  {}
name: building
</code></pre>
<h3 id="adding-a-vertex"><a class="header" href="#adding-a-vertex">Adding a vertex</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Icon</th><th style="text-align: center">Shortkey</th></tr></thead><tbody>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/vertex.svg" alt="Vertex icon" /></td><td style="text-align: center"><code>v</code></td></tr>
</tbody></table>
</div>
<p>A vertex is a fundamental component of multiple annotations.
Walls, measurements, doors, floor polygons and traffic lanes are created from two or more vertices.
To create a vertex, click on the vertex icon in the <code>Toolbar</code> and then click anywhere on the canvas.
The default attributes of a vertex are its coordinates along with an empty name field.
Additional attributes may be added by first selecting the vertex (which will turn it red), and then clicking the <code>Add</code> button in the figure.
Short descriptions of these are presented below:</p>
<ul>
<li><strong>is_holding_point:</strong> if true and if the waypoint is part of a traffic lane,
the <code>rmf_fleet_adapter</code> will treat this as a <em>holding point</em> during path
planning, i.e., the robot is allowed to wait at this waypoint for an indefinite
period of time.</li>
<li><strong>is_parking_spot:</strong> robot's parking spot. <a href="https://github.com/open-rmf/rmf_traffic/blob/40023b0f9b5d79a4781f6105f0368d74c1dfc443/rmf_traffic/include/rmf_traffic/agv/Graph.hpp#L73-L76">Definition</a></li>
<li><strong>is_passthrough_point:</strong> waypoint which the robot shouldnt stop. <a href="https://github.com/open-rmf/rmf_traffic/blob/40023b0f9b5d79a4781f6105f0368d74c1dfc443/rmf_traffic/include/rmf_traffic/agv/Graph.hpp#L63-L68">Definition</a></li>
<li><strong>is_charger:</strong> if true and if the waypoint is part of a traffic lane, the
<code>rmf_fleet_adapter</code> will treat this as a charging station.</li>
<li><strong>is_cleaning_zone</strong> indicate if current waypoint is a cleaning zone, specifically for <code>Clean</code> Task.</li>
<li><strong>dock_name:</strong> if specified and if the waypoint is part of a traffic lane, the
<code>rmf_fleet_adapter</code> will issue an <code>rmf_fleet_msgs::ModeRequest</code> message with
<code>MODE_DOCKING</code> and <code>task_id</code> equal to the specified name to the robot as it approaches this waypoint. This is used when the robot is executing their custom docking sequence (or custom travel path).</li>
<li><strong>spawn_robot_type:</strong> the name of the robot model to spawn at this waypoint in
simulation. The value must match the model's folder name in the assets
repository. More details on the robot model and plugin required for simulation
can be found in <a href="simulation.html">Simulation</a></li>
<li><strong>spawn_robot_name:</strong> a unique identifier for the robot spawned at this
waypoint. The <code>rmf_fleet_msgs::RobotState</code> message published by this robot
will have <code>name</code> field equal to this value.</li>
<li><strong>pickup_dispenser</strong> name of the dispenser workcell for <code>Delivery</code> Task, typically is the name of the model. See the [Workcell section] (https://osrf.github.io/ros2multirobotbook/simulation.html#workcells) of the Simulation Chapter for more details.</li>
<li><strong>dropoff_ingestor</strong> name of the ingestor workcell for <code>Delivery</code> Task, typically is the name of the model. See the [Workcell section] (https://osrf.github.io/ros2multirobotbook/simulation.html#workcells) of the Simulation Chapter for more details.</li>
<li><strong>human_goal_set_name</strong> The <code>goal_sets.set_area</code> name, used by crowd simulation. For more info about <code>crowd_sim</code>, please see the [Crowdsim section] (https://osrf.github.io/ros2multirobotbook/simulation.html#crowdsim) of the Simulation Chapter for more details.</li>
</ul>
<p><img src="images/traffic_editor/add_vertex.png" alt="Vertex attributes" /></p>
<p>Each vertex is stored in the <code>tutorial.building.yaml</code> file as a list of x-coordinate, y-coordinate, elevation, vertex_name and a set of additional parameters.</p>
<pre><code class="language-yaml">  vertices:
    - [1364.76, 1336.717, 0, magni1_charger, {is_charger: [4, true], is_parking_spot: [4, true], spawn_robot_name: [1, magni1], spawn_robot_type: [1, Magni]}]
</code></pre>
<h3 id="adding-a-measurement"><a class="header" href="#adding-a-measurement">Adding a measurement</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Icon</th></tr></thead><tbody>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/measurement.svg" alt="Measurement icon" /></td></tr>
</tbody></table>
</div>
<p>Adding a measurement sets the scale of the imported 2D drawing, which is essential for planning and simulation accuracy.
Scalebars or reference dimensions in the floor plan aid with the process. Often, you can draw the measurement line directly on top of a reference scale bar in a drawing.
With the editor in <em>Building</em> mode, select the <em>Add Measurement</em> tool and click on two points with known dimensions.
A pink line is rendered on the map with two vertices at its ends at the selected points.</p>
<p>Note:
A measurement line may be drawn by clicking on existing vertices.
In this scenario, no additional vertices are created at its ends.</p>
<p>Selecting the line populates various parameters in the Properties window of the <code>Sidebar</code>.
Setting the <code>distance</code> parameter to the physical distance between the points (in meters) will then update the <code>Scale</code> for the level.
Currently, you must save the project and restart <code>traffic-editor</code> to see the changes reflected (todo: fix this...).</p>
<p><img src="images/traffic_editor/add_measurement.png" alt="Measurement properties" /></p>
<p>The above process adds two <code>vertices</code> and a <code>measurement</code> field to the <code>tutorial.building.yaml</code> file as seen below.
For the measurement field, the first two elements represent the indices of vertices representing the ends of
the line.
The <code>distance</code> value is stored in a sub-list of parameters.</p>
<pre><code class="language-yaml">levels:
  L1:
    drawing:
      filename: office.png
    elevation: 0
    flattened_x_offset: 0
    flattened_y_offset: 0
    layers:
      {}
    measurements:
      - [1, 0, {distance: [3, 8.409]}]
    vertices:
      - [2951.728, 368.353, 0, &quot;&quot;]
      - [2808.142, 1348.9, 0, &quot;&quot;]

lifts:
  {}
name: building
</code></pre>
<h3 id="adding-a-wall"><a class="header" href="#adding-a-wall">Adding a wall</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Icon</th><th style="text-align: center">Shortkey</th></tr></thead><tbody>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/wall.svg" alt="Wall icon" /></td><td style="text-align: center"><code>w</code></td></tr>
</tbody></table>
</div>
<p>To annotate walls in the map, select the <em>Add Wall</em> icon from the <code>Toolbar</code> and click on consecutive vertices that represent the corners of the wall.
The process of adding wall segments is continuous, and can be exited by pressing the <code>Esc</code> key.
Blue lines between vertices are rendered on the map which represent the drawn walls.
If the corner vertices are not present, they will automatically be created when using this tool.
Meshes of the annotated walls are automatically generated during 3D world generation using <code>building_map_generator</code>.
By default, the walls are of thickness of 10cm and height 2.5m.
The <code>wall_height</code> and <code>wall_thickness</code> attributes may be
modified <a href="https://github.com/open-rmf/rmf_traffic_editor/blob/main/rmf_building_map_tools/building_map/wall.py#L16-L17">in the source code</a>.</p>
<p>Wall texture options are available <a href="https://github.com/open-rmf/rmf_traffic_editor/tree/main/rmf_building_map_tools/building_map_generator/textures">here</a> in the source code.</p>
<p><img src="images/traffic_editor/add_wall.png" alt="Annotating walls" /></p>
<p>Walls are stored in the <code>tutorial.building.yaml</code> file as a list with indices of start and end vertices of the wall segment along with an empty parameter set.</p>
<pre><code class="language-yaml">    walls:
      - [3, 4, {}]
      - [4, 5, {}]
      - [5, 6, {}]
      - [6, 7, {}]
      - [6, 8, {}]
      - [8, 9, {}]
</code></pre>
<h3 id="adding-a-floor"><a class="header" href="#adding-a-floor">Adding a floor</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Icon</th></tr></thead><tbody>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/floor.svg" alt="Floor icon" /></td></tr>
</tbody></table>
</div>
<p>Flooring is essential for simulations as it provides a ground plane for the robots to travel over.
Floors are annotated using the <em>Add floor polygon</em> tool from the <code>Main Toolbar</code> in <em>Building</em> edit mode.
To define a floor, select consecutive vertices to create a polygon that accurately represents the flooring area as seen below.
These vertices will need to be added manually prior to this step.
Once created, save the project and reload.
Selecting the defined floor highlights its texture attributes. Similarly, <a href="https://github.com/open-rmf/rmf_traffic_editor/tree/main/rmf_building_map_tools/building_map_generator/textures">default list of available textures</a> is available in the source code.</p>
<p><img src="images/traffic_editor/add_floor.png" alt="Highlighting floor's textures" /></p>
<p>Certain scenarios may call for floors with cavities, for example, to represent elevator shafts.
The <em>Add hole polygon</em> tool may be used for this purpose.
Additionally, the shape of a drawn polygon (floor or hole) may be modified using the <em>Edit polygon</em> tool.
Clicking on the tool after selecting an existing polygon enables the user to modify vertices of the polygon.</p>
<p>Each polygon is stored in the <code>tutorial.building.yaml</code> file in the format below:</p>
<pre><code class="language-yaml">    floors:
      - parameters: {texture_name: [1, blue_linoleum], texture_rotation: [3, 0], texture_scale: [3, 1]}
        vertices: [11, 10, 14, 15, 13, 12]
</code></pre>
<h3 id="adding-a-door"><a class="header" href="#adding-a-door">Adding a door</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Icon</th></tr></thead><tbody>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/door.svg" alt="Door icon" /></td></tr>
</tbody></table>
</div>
<p>A door between two vertices can be added in <em>Building</em> edit mode by selecting the <em>Add door</em> tool from the <code>Main Toolbar</code>, and clicking on vertices representing the ends of the door.
Selecting an annotated door highlights its properties as seen in the figure below.
Presently, four door <code>types</code> are supported: &quot;hinged&quot;, &quot;double_hinged&quot;, &quot;sliding&quot; and &quot;double_sliding&quot;.
The <code>motion_degrees</code> parameter specifies the range of motion in the case of hinged doors while the <code>motion_direction</code> dictates the direction of swing.
In order for the door to work in simulation, a <code>name</code> must be given to the door.</p>
<p><img src="images/traffic_editor/add_door.png" alt="Door type properties" /></p>
<p>Doors are stored in the <code>tutorial.building.yaml</code> file as a list with indices of start and end vertices along with the set of parameters that describes the door.</p>
<pre><code class="language-yaml"> doors:
      - [24, 25, {motion_axis: [1, start], motion_degrees: [3, 90], motion_direction: [2, 1], name: [1, D001], type: [1, double_sliding]}]
</code></pre>
<h3 id="adding-a-traffic-lane"><a class="header" href="#adding-a-traffic-lane">Adding a traffic lane</a></h3>
<p>One of the most important tools in the <code>traffic_editor</code> GUI is the <em>Add lane</em> tool.
The allowable motions of each fleet operating in the facility is conveyed through its respective Graph which consists of waypoints and connecting lanes.
In this approach, we assume that robots travel along effectively straight-line paths between waypoints.
While this may be perceived as an oversimplification of paths taken by robots that are capable of autonomous navigation, in practice the assumption holds fairly well given that these robots mostly travel along corridors or hallways and seldom in unconstrained open spaces.
For example, even in theoretically unconstrained spaces like building lobbies or shopping-mall atriums, it is likely that the site operator would prefer for the robots to operate in a &quot;traffic lane&quot; on the edge of the space, in order to not impede typical human traffic flows.</p>
<p>The <code>traffic</code> tab in the <code>Sidebar</code> has a default of nine Graphs for nine different fleets. To annotate lanes for a graph, say Graph 0, select the Graph from the <code>traffic</code> tab and click the <em>Add lane</em> tool.
Lanes for this graph can be drawn by clicking vertices to be connected.
If a vertex is not present, it will automatically be added. Properties may be assigned to each vertex as described in the preceding section.
To issue tasks to waypoints that require the robot to terminate at any waypoint, a name must be assigned to the waypoint.</p>
<p><img src="images/traffic_editor/add_lane.png" alt="Graphs' lane colors" /></p>
<p>Each Graph has a unique color for its lanes, and their visibility may be toggled using the checkbox in the <code>traffic</code> tab.
A lane that is defined between two waypoints may be configured with these additional properties:</p>
<ul>
<li><strong>bidirectional:</strong> if <code>true</code>, the <code>rmf_fleet_adapter</code> will plan routes for its
robot assuming the lanes can be traversed in both directions. Lanes that are
not bidirectional have arrows indicating their directionality (indigo lanes in
figure above). A handy shortcut is that when a lane segment is selected, you can
press the <code>b</code> key to toggle between unidirectional and bidirectional motion along that lane.</li>
<li><strong>graph_idx</strong>: the Graph number a lane corresponds to</li>
<li><strong>orientation</strong>: constrain the lane to make the robot travel in <code>forward</code> or <code>backward</code> orientation. This can be useful for the final lane segment approaching a docking point or charger, for example.</li>
</ul>
<p>While lifts that move between levels are now supported in the <code>traffic_editor</code>, the <strong>demo_mock_floor_name</strong> and <strong>demo_mock_lift_name</strong> properties were originally engineered to showcase shared lift access in a single floor demonstration environment with a &quot;mock&quot; lift that receives lift commands and transmits lift states but does not actually move between any different floors in a building.
However, as there may be interest in such functionality for testing single-floor hardware setups that seek to emulate multi-floor scenarios, these properties were retained.</p>
<ul>
<li><strong>demo_mock_floor_name</strong>: name of the floor that the robot is on while
traversing the lane</li>
<li><strong>demo_mock_lift_name</strong>: name of the lift that is being entered or exited
while the robot traverses the lane</li>
</ul>
<p>To further explain these properties, consider this representation of a
navigation graph where numbers are waypoints and letters are lanes:</p>
<pre><code>1 &lt;---a---&gt; 2 &lt;---b---&gt; 3

Waypoint 1 is on floor L1
Waypoint 2 is inside the &quot;lift&quot; named LIFT001
Waypoint 3 is on floor L3
The properties of edge &quot;a&quot; are:
    bidirectional: true
    demo_mock_floor_name: L1
    demo_mock_lift_name: LIFT001
The properties of edge &quot;b&quot; are:
    bidirectional: true
    demo_mock_floor_name: L3
    demo_mock_lift_name: LIFT001
</code></pre>
<p>If the robot is to travel from waypoint 1 to waypoint 3, the <code>rmf_fleet_adapter</code> will request for the &quot;mock lift&quot; to arrive at L1 when the robot approaches waypoint 1.
With confirmation of the &quot;lift&quot; at L1 and its doors in &quot;open&quot; state, the robot will be instructed to move into the &quot;lift&quot; to waypoint 2.
Once the &quot;lift&quot; indicates that it has reached L3, the robot will exit along lane b toward waypoint 3.</p>
<p>Note: when annotating graphs, it is highly recommended to follow an ascending sequence of graph indices without skipping intermediate numbers. Drawn lanes can only be interacted with if their associated Graph is first selected in the <code>traffic</code> tab.</p>
<p>The annotated Graphs are eventually exported as <code>navigation graphs</code> using the <code>building_map_generator</code> which are then used by respective <code>rmf_fleet_adapters</code> for path planning.</p>
<p>Lanes are stored in the following format in <code>tutorial.building.yaml</code>.
The data structure is a list with the first two elements representing the indices of the two vertices of the lane and a set of parameters with configured properties.</p>
<pre><code class="language-yaml">    lanes:
      - [32, 33, {bidirectional: [4, true], demo_mock_floor_name: [1, &quot;&quot;], demo_mock_lift_name: [1, &quot;&quot;], graph_idx: [2, 2], orientation: [1, forward]}]
</code></pre>
<h3 id="deriving-coordinate-space-transforms"><a class="header" href="#deriving-coordinate-space-transforms">Deriving coordinate-space transforms</a></h3>
<p>Coordinate spaces are confusing!
For historical reasons, the GUI internally creates traffic maps by annotating images, so the &quot;raw&quot; annotations are actually encoded in pixel coordinates of the &quot;base&quot; floorplan image, in pixel coordinates, with +X=right and +Y=down, with the origin in the upper-left of the base floorplan image.
However, during the building map generation step, the vertical axis is flipped to end up in a Cartesian plane, so the vast majority of RMF (that is, everything downstream of traffic-editor and the building map generators) uses a &quot;normal&quot; Cartesian coordinate system. (As an aside -- the next version of traffic-editor is intended to be more flexible in this respect, and will default to a normal Cartesian coordinate system (not an image-based coordinate system), or even global coordinates (lat/lon). Although preliminary work is underway, there is not a hard schedule for this next-gen editor at time of writing, so the rest of this chapter will describe the existing <code>traffic-editor</code>.)</p>
<p>Although <code>traffic-editor</code> currently uses the upper-left corner of the base floorplan image as the reference frame, maps generated by robots likely will have their origin elsewhere, and will likely be oriented and scaled differently.
It is critical to derive the correct transform between coordinate frames in <code>traffic_editor</code> maps and robot maps as
<code>rmf_fleet_adapters</code> expect all robots to publish their locations in the RMF coordinate system while the <code>rmf_fleet_adapters</code> also issue path requests in the same frame.</p>
<p>To derive such transforms, the <code>traffic_editor</code> GUI allows users to overlay robot maps on a floor plan and apply scale, translation and rotation transformations such that the two maps align correctly.
The user can then apply the same transformations to convert between robot map and RMF coordinates when programming interfaces for their robot.</p>
<p>The robot map can be imported by clicking the <code>Add</code> button from the <code>layers</code> tab in the <code>Sidebar</code>.
A dialog box will then prompt the user to upload the robot map image.
The same box contains fields for setting the scale for the image along with applying translations and rotation.
Through visual feedback, the user can determine appropriate values for these fields.
As seen in the image below, importing the robot-generated map into the GUI has it located and oriented
differently than the floor plan.
With the right transformation values, the two maps can be made to overlap.</p>
<p><img src="images/traffic_editor/coordinate_transform.png" alt="Overlap robot-generated map" /></p>
<h3 id="adding-fiducials"><a class="header" href="#adding-fiducials">Adding fiducials</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Icon</th></tr></thead><tbody>
<tr><td style="text-align: center"><img src="images/traffic_editor/icons/fiducial.svg" alt="Fiducial icon" /></td></tr>
</tbody></table>
</div>
<p>For maps with multiple levels, fiducials provide a means to scale and align different levels with respect to a reference level.
This is crucial for ensuring dimensional accuracy of annotations across different levels and aligning the
same for simulation.
Fiducials are reference markers placed at locations which are expected to be vertically aligned between two or more levels.
For example, structural columns may run through multiple floors and their locations are often indicated on floor plans.
With two or more pairs of corresponding markers between a level and a reference level, a geometric transformation (translation, rotation and scale) may be derived between the two levels.
This transformation can then be applied to all the vertices and models in the newly defined level.</p>
<p>To begin, add two or more non-collinear fiducials to the reference level with unique <code>name</code> attributes using the <em>Add fiducial</em> tool (left image in figure below).
In the newly created level, add the same number of fiducials at locations that are expected to be vertically aligned with matching names as the reference level (right image in figure below).
Saving and reloading the project computes the transformation between the levels which is evident from the Scale
and X-Y offsets for the new level as seen in the <code>levels</code> tab.
This level is now ready to be annotated.</p>
<p><img src="images/traffic_editor/add_fiducial.png" alt="Adding fiducials" /></p>
<p>For each level, fiducials are stored in a list of their X &amp; Y coordinates along with their name.</p>
<pre><code class="language-yaml">    fiducials:
      - [936.809, 1323.141, F1]
      - [1622.999, 1379.32, F2]
      - [2762.637, 346.69, F3]
</code></pre>
<h3 id="adding-a-lift"><a class="header" href="#adding-a-lift">Adding a lift</a></h3>
<p>Lifts are integral resources that are shared between humans and robot fleets in multi-level facilities.
To add a lift to a building, click the <code>Add</code> button in the <code>lifts</code> tab in the <code>Sidebar</code>.
A dialog box with various configurable properties will load.
It is essential to specify the Name, Reference level and the X&amp;Y coordinates (pixel units) of its cabin center.
A yaw (radians) may further be added to orient the lift as desired.
The width and depth of the cabin (meters) can also be customized.
Lifts can be designed to have multiple cabin doors which may open at more than one level.
To add a cabin door, click the <code>Add</code> button in the box below the cabin image.
Each cabin door requires a name along with positional and orientational information.
Here, the X&amp;Y coordinates are relative to the cabin center.</p>
<p><img src="images/traffic_editor/add_lift.png" alt="Configuring lift properties" /></p>
<p>The configured lift is stored in the <code>tutorial.building.yaml</code> file as described below:</p>
<pre><code class="language-yaml">lifts:
  LF001:
    depth: 2
    doors:
      door1:
        door_type: 2
        motion_axis_orientation: 1.57
        width: 1
        x: 1
        y: 0
      door2:
        door_type: 2
        motion_axis_orientation: 1.57
        width: 1
        x: -1
        y: 0
    level_doors:
      L1: [door1]
      L2: [door2]
    reference_floor_name: L1
    width: 2
    x: 827
    y: 357.7
    yaw: 1.09
</code></pre>
<p>After adding the lift, we would also wish to let our robots to transverse through the lift.
To achieve that, the user needs to create vertices/waypoints which are located within the lift cabin on each floor.
Once done, connect the waypoint within the lift cabin to other vertices via <strong>add_lane</strong>.</p>
<h3 id="adding-environment-assets"><a class="header" href="#adding-environment-assets">Adding environment assets</a></h3>
<p>Levels may be annotated with thumbnails of models available for simulation using the <strong>Add model</strong> tool in <strong>Building</strong> edit mode.
Selecting this tool opens a dialog box with a list of model names and matching thumbnails which can be imported to the map.
Once on the map, their positions and orientations can be adjusted using the <em>Move</em> and <em>Rotate</em> tools. Sample models are provided <a href="https://github.com/open-rmf/rmf_traffic_editor/tree/main/rmf_traffic_editor_assets/assets/thumbnails/images/cropped/OpenRobotics">here</a></p>
<p>The <a href="https://github.com/open-rmf/rmf_traffic_editor/tree/main/rmf_traffic_editor#generating-custom-thumbnails">thumbnail_generator documentation</a> contains instructions on expanding the list of thumbnails for other models.</p>
<blockquote>
<p>Note: If no models are shown on the <strong>add models</strong> window, Go to &quot;Edit -&gt; Preference&quot;, then indicate the thumbnail path. (<code>e.g. $HOME/rmf_ws/src/rmf/rmf_traffic_editor/rmf_traffic_editor_assets/assets/thumbnails</code>)</p>
</blockquote>
<p><img src="images/traffic_editor/add_model.png" alt="Model name and thumbnails dialog" /></p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>This chapter covered various capabilities of the <code>traffic_editor</code> which are useful for annotating maps of facilities while adhering to a standardized set of semantics.
Examples of other traffic editor projects can be found in the <a href="https://github.com/open-rmf/rmf_demos">rmf_demos</a> repository.
Running physics based simulations with RMF in the annotated sites is described in the <a href="simulation.html">Simulation</a> chapter.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/osrf/ros2multirobotbook/edit/main/src/traffic-editor.md">Edit this page on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ros2_api.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="simulation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ros2_api.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="simulation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
